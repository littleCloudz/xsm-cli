#!/usr/bin/env node

process.title = 'xsm'

var _ = '  ' // text indent
var DefaultGruntFile = 'gruntfile.js'
var DefaultGruntTask = 'default'

var args = process.argv
var gruntfile = args[2]

if (!gruntfile || gruntfile === '--help' || gruntfile === '-h') {
	return usage()
}

var basedir = process.cwd()
var xsmfile = require('path').resolve(basedir, 'xsmfile.js')
var GruntfileConfig

try {
	GruntfileConfig = require(xsmfile)
} catch (e) {
	console.error('xsmfile.js not found.')
	GruntfileConfig = {}
}

if (!gruntfile) {
	console.error('no grunt-file arg, use default [' + DefaultGruntFile + ']')
}

gruntfile = GruntfileConfig[gruntfile] || DefaultGruntFile

// get grunt task
var grunttask = args[3]

if (!grunttask) {
	console.error('no grunt-task arg, use default [' + DefaultGruntTask + ']')
	grunttask = DefaultGruntTask
}

// call sub grunt
require('child_process').spawn(
	process.platform === "win32" ? 'grunt.cmd' : 'grunt', [
	'--gruntfile', gruntfile,
	'--base', './',
	grunttask
], {
	stdio: 'inherit'
})

function usage() {
	console.log([
		'Usage:',
		'xsm <grunt-file> <grunt-task>',
		'',
		'<param>',
		'grunt-file:',
		_ + 'sub gruntfile configed in xsmfile.js',
		'grunt-task:',
		_ + 'grunt task in sub gruntfile',
		'',
		'<Example>',
		'xsmfile.js:',
		_ + 'module.exports = {',
		_ + 'order: "grunt/order/gruntfile.js"',
		_ + '}',
		'cmd:',
		_ + 'xsm order uglify',
		'',
		'For more info, go to:',
		'https://github.com/xsm-ue/xsm-cli#readme'
	].join('\n'))
}