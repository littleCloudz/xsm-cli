#!/usr/bin/env node

var fs = require('fs')

process.title = 'xsm'

var _ = '  ' // text indent
var DefaultGruntFile = 'gruntfile.js'
var DefaultGruntTask = 'default'

var args = process.argv
var gruntfile = args[2]

/* show usage */

if (gruntfile === '--help' || gruntfile === '-h') {
	usage()
	process.exit(1)
}

/* get grunt file config */

var basedir = process.cwd()
var xsmfile = require('path').resolve(basedir, 'xsmfile.js')
var GruntfileConfig

if (!fs.existsSync(xsmfile)) {
	console.error('xsmfile.js not found.')
	console.log('try use "' + DefaultGruntFile + '"')
	gruntfile = DefaultGruntFile
} else {
	if (!gruntfile) {
		console.error('no grunt-file arg, use default file "' + DefaultGruntFile + '"')
		gruntfile = DefaultGruntFile
	} else {
		try {
			GruntfileConfig = require(xsmfile)
			gruntfile = GruntfileConfig[gruntfile]
		} catch (e) {
			console.error('xsmfile.js is not a valid CommonJS file.')
			console.error(e)
			process.exit(1)
		}
		if (!gruntfile) {
			console.error('no such gruntfile config in xsmfile')
			process.exit(1)
		}
	}
}

if (!fs.existsSync(gruntfile)) {
	console.error('gruntfile not existed at:\n"' + gruntfile + '"')
	process.exit(1)
}

/* get grunt task config */

var grunttask = args[3]

if (!grunttask) {
	console.error('no grunt-task arg, use default task [' + DefaultGruntTask + ']')
	grunttask = DefaultGruntTask
}

/* call sub grunt with specified grunt file and grunt task config */

require('child_process').spawn(
	process.platform === "win32" ? 'grunt.cmd' : 'grunt', [
	'--gruntfile', gruntfile,
	'--base', './',
	grunttask
], {
	stdio: 'inherit'
})

function usage() {
	console.log([
		'Usage:',
		'xsm [grunt-file [grunt-task]]',
		'',
		'<param>',
		'grunt-file:',
		_ + 'sub gruntfile configed in xsmfile.js',
		_ + 'if not given, use "Gruntfile.js"',
		'grunt-task:',
		_ + 'grunt task in sub gruntfile',
		_ + 'if not given, use "default"',
		'',
		'<Example>',
		'xsmfile.js:',
		_ + 'module.exports = {',
		_ + _ + 'order: "grunt/order/gruntfile.js"',
		_ + '}',
		'cmd:',
		_ + 'xsm order uglify',
		'',
		'For more info, go to:',
		'https://github.com/xsm-ue/xsm-cli#readme'
	].join('\n'))
}